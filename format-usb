#!/bin/bash
##
## format-usb
## ----------
## Quickly create an msdos partition table and a single, FAT32 filesystem
## on a given USB flash drive for use with Windows.
##
## Usage: format-usb [device] [optional partition label]
##
if [ "$1" == "" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ] ; then
  grep -E '^##[^#]?' "$0"
  if [ "$1" == "" ] ; then
    echo
    echo "Available devices:"
    fdisk -l | grep -E '/dev/sd[a-z][^0-9]'
    echo
  fi
  exit
fi

DEVICE=$1
LABEL=$2

# Unmount current partitions
for d in $(fdisk -l | grep "$1" | grep "$1[0-9]" | cut -d ' ' -f 1); do 
  umount -f $d
done

# Create the new partition table
parted $DEVICE mktable msdos yes
partprobe

# Create a single primary partition, type 0b
echo -en "n\np\n1\n\n\na\nt\n0b\nw\n" | fdisk $DEVICE
partprobe

# Format the partition as type vfat and apply provided label
if [ "$LABEL" != "" ] ; then
  mkfs.vfat -n "$LABEL" $DEVICE"1"
else
  mkfs.vfat $DEVICE"1"
fi
sync
partprobe

eject $DEVICE && echo "$DEVICE Ejected"'!' && echo "Please remove the flash drive now."
