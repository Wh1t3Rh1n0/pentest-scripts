#!/bin/bash
##
## format-usb
## ----------
## Quickly create an msdos partition table and a single, FAT32 filesystem
## on a given USB flash drive for use with Windows.
##
## Usage: format-usb [device] [optional partition label] [optional fs type]
##
## You must provide a label if specifying the filesystem type.
##
## Accepted filesystem flags:
##    --ntfs
##    --exfat
##
if [ "$1" == "" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ] ; then
  grep -E '^##[^#]?' "$0"
  if [ "$1" == "" ] ; then
    echo
    echo "Available devices:"
    fdisk -l | grep -E '/dev/sd[a-z][^0-9]'
    echo
  fi
  exit
fi

DEVICE=$1
LABEL=$2

echo "DEVICE=$DEVICE"
echo "LABEL=$LABEL"

if [ "$(echo \"$*\" | grep '\--ntfs')" != "" ] ; then
    FS=--ntfs
fi

if [ "$(echo \"$*\" | grep '\--exfat')" != "" ] ; then
    FS=--exfat
    if [ "$(which mkfs.exfat)" == "" ] ; then
        echo "Could not find mkfs.exfat"
        echo "Make sure these packages are installed: exfat-utils exfat-fuse"
        exit
    fi 
fi


# Unmount current partitions
for d in $(fdisk -l | grep "$1" | grep "$1[0-9]" | cut -d ' ' -f 1); do 
  umount -f $d
done

# Overwrite MBR and partition table
dd if=/dev/zero of=$DEVICE bs=512 count=1
partprobe

# Wipe out any existing GPT
cat <<EOF | gdisk $DEVICE
x
z
y
y
EOF

partprobe

# Create the new partition table
echo parted $DEVICE mktable msdos yes
#parted $DEVICE mktable msdos yes
cat <<EOF | parted $DEVICE
mktable
msdos
quit
EOF

partprobe

# Create a single primary partition
if [ "$FS" == "--ntfs" || "$FS" == "--exfat" ] ; then
    # NTFS/EXFAT
    FSTYPE=7
else
    # FAT32
    FSTYPE=0b
fi
echo -en "n\np\n1\n\n\na\nt\n$FSTYPE\nw\n" | fdisk $DEVICE
partprobe

# Format the partition and apply provided label
if [ "$FS" == "--ntfs" ] ; then
    # NTFS
    if [ "$LABEL" != "" ] ; then
        mkfs.ntfs -L "$LABEL" -Q $DEVICE"1"
    else
        mkfs.ntfs -Q $DEVICE"1"
    fi
elif [ "$FS" == "--exfat" ] ; then
    # exfat
    if [ "$LABEL" != "" ] ; then
        mkfs.exfat -n "$LABEL" $DEVICE"1"
    else
        mkfs.exfat $DEVICE"1"
    fi
else
    # VFAT
    if [ "$LABEL" != "" ] ; then
        mkfs.vfat -n "$LABEL" $DEVICE"1"
    else
        mkfs.vfat $DEVICE"1"
    fi
fi
sync
partprobe

eject $DEVICE && echo "$DEVICE Ejected"'!' && echo "Please remove the flash drive now."
