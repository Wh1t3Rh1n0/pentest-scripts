#!/bin/bash
##
## mkwinusb
## --------
## Create a bootable USB Windows 7, 8, or 10 install media from an ISO
##
## Usage: mkwinusb [ISO] [device] <optional FS label>
##
if [ "$1" == "" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ] ; then
  grep -E '^##[^#]?' "$0"
  if [ "$1" == "" ] ; then
    echo
    echo "Available devices:"
    fdisk -l | grep -E '/dev/sd[a-z][^0-9]'
    echo
  fi
  exit
fi

ISO=$1
DEVICE=$2
LABEL=$3

if [ "$LABEL" == "" ]; then
    LABEL=Windows
fi

# Check that ms-sys is installed
if [ "$(which ms-sys)" == "" ] ; then
    cat <<EOF
You must install ms-sys for this script to work.

Download here: http://sourceforge.net/projects/ms-sys/files/
EOF
    exit
fi

## Check that the ISO is valid
#if [ "$(file \"$ISO\" | grep -iEo 'bootable')" == "" ] ; then
#    echo "The ISO you are using does not appear to be a bootable Windows ISO."
#    exit
#fi

# Unmount current partitions
for d in $(fdisk -l | grep "$DEVICE" | grep "$DEVICE[0-9]" | cut -d ' ' -f 1); do 
  umount -f $d
done

# Overwrite MBR and partition table
dd if=/dev/zero of=$DEVICE bs=512 count=1
partprobe

# Wipe out any existing GPT
cat <<EOF | gdisk $DEVICE
x
z
y
y
EOF
partprobe

# Create the new partition table
echo parted $DEVICE mktable msdos yes
#parted $DEVICE mktable msdos yes
cat <<EOF | parted $DEVICE
mktable
msdos
quit
EOF

partprobe

# Create a single primary partition
FSTYPE=7
echo -en "n\np\n1\n\n\na\nt\n$FSTYPE\nw\n" | fdisk $DEVICE
partprobe

# Format the partition and apply provided label
mkfs.ntfs -Q $DEVICE"1" -L "$LABEL"
sync
partprobe

# Install the Windows MBR
ms-sys -7 $DEVICE

# Mount the ISO
mkdir /tmp/mnt.iso
mount "$ISO" /tmp/mnt.iso -o loop,ro

# Mount the USB
mkdir /tmp/mnt.usb
mount -t ntfs $DEVICE"1" /tmp/mnt.usb -o rw

# Copy all files from the ISO to the USB
cp -Rv /tmp/mnt.iso/* /tmp/mnt.usb

# Unmount the ISO and USB
umount /tmp/mnt.iso
umount /tmp/mnt.usb

echo 'Done!'

#eject $DEVICE && echo "$DEVICE Ejected"'!' && echo "Please remove the flash drive now."
