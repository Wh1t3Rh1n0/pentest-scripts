#!/bin/bash

##
## live-usb-tweaks.sh
## ------------------
## Install tweaks to increase performance when running
## Kali from a LiveUSB with persistence.
##
## Usage: ./live-usb-tweaks.sh install
##

if [ "$1" == "" ] || [ "$1" == "--help" ] || [ "$1" == "-h" ] ; then
    grep -E "^##( |$)" "$0"
    exit
fi

echo "Installing LiveUSB tweaks..."

### Changes to rc.local ###

sed -i 's/exit 0//g' /etc/rc.local

cat <<EOF >> /etc/rc.local
# Limit writes to the persistent volume to every 120 seconds
mount -o remount,noatime,commit=120 /lib/live/mount/persistence/loop1

#Mount /tmp onto ramdisk 
mkdir /dev/shm/tmp
chmod 1777 /dev/shm/tmp
mount --bind /dev/shm/tmp /tmp

#Mount  /var/cache/apt/archives onto ramdisk 
mkdir /dev/shm/apt-archives
chmod 1777 /dev/shm/apt-archives
mount --bind /dev/shm/apt-archives /var/cache/apt/archives
EOF

echo -e "\nexit 0" >> /etc/rc.local


### Disable rsyslog ###
update-rc.d rsyslog disable


### Add these lines to /etc/sysctl.conf ###
cat <<EOF >> /etc/sysctl.conf
vm.swappiness = 0
vm.dirty_background_ratio = 20
vm.dirty_expire_centisecs = 0
vm.dirty_ratio = 80
vm.dirty_writeback_centisecs = 0
EOF


echo "Reboot for changes to take effect."
