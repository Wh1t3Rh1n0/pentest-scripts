#!/bin/bash

##
## iplist-detect_http
## ------------------
## Retrieves HTTP headers from each server listed in a IP:Port formatted file.
##
## Usage: iplist-detect_http <IP List File> [Maximum Connect Timeout]
##

if [ "$1" == "" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
  grep -E "^##($|[^#])" "$0"
  exit
fi


IPLIST=$1

if [ "$2" == "" ] ; then
  MAX_TIMEOUT=2
else
  MAX_TIMEOUT=$2
fi

for ip in $(cat "$IPLIST"); do
  CURL_COMMAND="curl -s --retry 0 --retry-delay 0 --retry-max-time $MAX_TIMEOUT -I --connect-timeout $MAX_TIMEOUT -m $MAX_TIMEOUT -y $MAX_TIMEOUT -k"

  RESPONSE=$($CURL_COMMAND http://$ip | head -n 3 |tr -d "\r" | tr "\n" "|")
  echo "http://$ip > $RESPONSE" 

  RESPONSE=$($CURL_COMMAND https://$ip | head -n 3 |tr -d "\r" | tr "\n" "|")
  echo "https://$ip > $RESPONSE" 
done
