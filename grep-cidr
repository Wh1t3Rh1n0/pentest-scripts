#!/bin/bash
##
## grep-cidr
## ---------
## Searches a target file for any IP addresses in the given range. Any range
## format that is Nmap compatible *should work*, not just CIDR.
##
## Usage: grep-cidr <IP Range> <Target File> [Additional grep options]
##

if [ "$1" == "--help" ] || [ "$1" == "-h" ] ; then
    grep -E '^## ?' "$0" | sed -E 's/^## ?//g'
    exit
fi

IP_RANGE=$1
TARGET_FILE=$2
GREP_OPTIONS=$3 $4 $5 $6 $7 $8 $9
TEMP_FILE=/tmp/grep-cidr.temp-$RANDOM

# Use Nmap to generate a list of IPs in the given range and save them in a temporary file
nmap -Pn -n -sL -oG - $IP_RANGE | grep Host: | cut -d ' ' -f 2 > $TEMP_FILE

# Grep the target file for IPs in the specified range
grep -F -f "$TEMP_FILE" "$TARGET_FILE"

# Delete the temp file
rm -f $TEMP_FILE