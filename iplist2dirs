#!/bin/bash

##
## iplist2dirs
## -----------
## Reads an IP:Port list and creates the following directory structure for 
## each IP address:
##
##     ./[OUTPUT DIR]/[PORT]/[IP Address]
##
## Usage: iplist2dirs <IP List> [Ports]
##
## Example: iplist2dirs iplist.txt "80 443"
##
## Use "all" in place of port numbers to create a directory for every port listed.
##
## If ports are omitted, the default port list is used.
## The defaul port list and output directory name can be changed in the settings
## section of this script.
##

# SETTINGS #
DEFAULT_PORTS="21 22 23 25 53 80 110 139 443 445 3389 5800 5900"
OUTPUT_DIR="hosts"
# END SETTINGS #

if [ "$1" == "" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ] ; then
    grep "^##" "$0"
    exit
fi

if [ "$2" == "" ] ; then
    PORTS="$DEFAULT_PORTS"
elif [ "$2" == "all" ] ; then
    PORTS="$(cat $1 | cut -d ':' -f 2 | sort -u | tr '\n' ' ')"
else
    PORTS="$2"
fi

IP_LIST="$PWD/$1"

for port in $PORTS; do
    mkdir -p "$OUTPUT_DIR/$port"
    for ip in $(grep ":$port$" "$IP_LIST" |cut -d ':' -f 1 ) ; do
        # touch "$OUTPUT_DIR/$port/$ip"
        mkdir -p "$OUTPUT_DIR/$port/$ip"
    done
done
