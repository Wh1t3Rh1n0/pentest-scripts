#!/bin/bash
##
## ----------------------------------
## setup-x-limited.sh | by Wh1t3Rh1n0 
## ----------------------------------
##
## This script creates a script and a menu icon for executing a given program
## as a regular, non-root user while you are logged in as root. Fully tested
## with Kali Linux 1.0.7 where I do not like running my web browser, IRC 
## client, etc. as root, but logging in as root is so convenient for everything
## else.
##
## The following environment variables need to be set for it to run:
##
## script_name - the filename that the created script will be saved as.
## iw_user - the user that will be created for running the target program.
## program_description - the name that will show on the icon.
## command_line - the path of the target program to be run.
## icon - the icon to display on the menu
## categories - where the icon is placed within the applications menu.
##
## Example execution:
## ------------------
## script_name=firefox-nonroot iw_user=firefox-user \
## program_description="Firefox (Non-Root)" \
## command_line="/opt/firefox/firefox" \
## icon="/opt/firefox/browser/icons/mozicon128.png" catagories="Network;" \
## ./setup-x-limited.sh
##


if [ "$iw_user" == "" ] || [ "command_line" == "" ] || [ "program_description" == "" ] ; then
    grep -E "^##([^#]|$)" "$0"
    exit
fi

### SETTINGS ###
# Change the values below to set this script up for the desired program.

# script_name is the filename that the created script will be saved as.
#script_name=iceweasel-nonroot

# iw_user is the user that will be created for the purpose of running the
# target program.
#iw_user=iceweasel-user

# program_description is the name that will show on the icon.
#program_description="Iceweasel (Non-Root)"

# command_line is the path of the target program to be run.
#command_line="/usr/bin/iceweasel"

# icon is the icon to display on the menu. If unknown, you can find it by
# examining /usr/share/applications/<program name>.desktop
#icon="iceweasel"

# categories determines where the icon is placed within the applications menu.
# Like icon, if you don't know it, you can find it in 
# /usr/share/applications/<program name>.desktop
#catagories="Network;"

### END OF SETTINGS ###


useradd -G audio,pulse,pulse-access $iw_user
mkdir /home/$iw_user
chown -R $iw_user /home/$iw_user


cat << EOF > /usr/bin/$script_name
#!/bin/bash
cp \$XAUTHORITY /home/$iw_user/.Xauth
chmod 400 /home/$iw_user/.Xauth
chown $iw_user /home/$iw_user/.Xauth
sudo -u $iw_user -i XAUTHORITY=/home/$iw_user/.Xauth $command_line \$*
EOF
chmod 555 /usr/bin/$script_name


cat << EOF > /usr/share/applications/$script_name.desktop
[Desktop Entry]
Encoding=UTF-8
Name=$program_description
Comment=$program_description
GenericName=$program_description
X-GNOME-FullName=$program_description
Exec=/usr/bin/$script_name
Terminal=false
X-MultipleArgs=false
Type=Application
Icon=$icon
Categories=$catagories
StartupNotify=true
EOF



### Below is automatic compatibility tracking for future versions of Kali ###
echo \# Last tested [`date`] on [`cat /etc/issue | tr -d "\n"`] >> $0

# Last tested [Thu Feb 12 15:55:40 EST 2015] on [Kali GNU/Linux 1.1.0 \n \l]
# Last tested [Thu Feb 12 15:56:13 EST 2015] on [Kali GNU/Linux 1.1.0 \n \l]
# Last tested [Tue Apr 7 05:44:44 EDT 2015] on [Kali GNU/Linux 1.1.0 \n \l]
# Last tested [Wed Apr 8 09:02:30 EDT 2015] on [Kali GNU/Linux 1.1.0 \n \l]
# Last tested [Wed Apr 8 09:04:47 EDT 2015] on [Kali GNU/Linux 1.1.0 \n \l]
# Last tested [Mon Jun 22 12:03:49 EDT 2015] on [Kali GNU/Linux 1.1.0 \n \l]
# Last tested [Mon Jun 22 12:03:49 EDT 2015] on [Kali GNU/Linux 1.1.0 \n \l]
