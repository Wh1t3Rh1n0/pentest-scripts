#!/bin/bash

##
## setup-torbrowser-limited.sh | by Wh1t3Rh1n0 
## -------------------------------------------
## 
## usage: setup-torbrowser-limited.sh <full path to torbrowser.xz file>
##
## uninstall: setup-torbrowser-limited.sh --remove
##


# SETTINGS ###
# Change the values below to set this script up for the desired program.

# script_name is the filename that the created script will be saved as.
script_name=tor-nonroot

# iw_user is the user that will be created for the purpose of running the
# target program.
iw_user=tor-user

# command_line is the path of the target program to be run.
command_line="/opt/tor-browser_en-US/start-tor-browser"

# END OF SETTINGS ###

if [ "$1" == "" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ] ; then
    grep "^##" "$0"
    exit
fi

if [ "$1" == "--remove" ] ; then 
    echo "Undoing all changes..."
    pkill -U $(id tor-user | cut -d '=' -f 2 | cut -d '(' -f 1)
    deluser $iw_user
    delgroup $iw_user
    rm -rf /home/$iw_user
    rm -rfv /opt/tor-browser_en-US
    echo "Done."
    exit
fi


cd /opt
tar -xJvf "$1"


useradd -G audio,pulse,pulse-access $iw_user
mkdir /home/$iw_user
chown -R $iw_user /home/$iw_user


cat << EOF > /opt/tor-browser_en-US/$script_name
#!/bin/bash
cp \$XAUTHORITY /home/$iw_user/.Xauth
chmod 400 /home/$iw_user/.Xauth
chown $iw_user /home/$iw_user/.Xauth
chown -R tor-user:tor-user /opt/tor-browser_en-US
cd /opt/tor-browser_en-US
sudo -u $iw_user -i XAUTHORITY=/home/$iw_user/.Xauth $command_line \$*
EOF
chmod 555 /opt/tor-browser_en-US/$script_name


# Below is automatic compatibility tracking for future versions of Kali ###
echo \# Last tested [`date`] on [`cat /etc/issue | tr -d "\n"`] >> $0

# Last tested [Thu Feb 19 16:04:27 EST 2015] on [Kali GNU/Linux 1.1.0 \n \l]
